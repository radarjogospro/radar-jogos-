<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071b1b" />
  <title>Radar Jogos PRO</title>
  <style>
    :root{
      --bg0:#061818;
      --bg1:#071f1f;
      --card:#0b2424cc;
      --card2:#0b2424b3;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --muted2:rgba(255,255,255,.52);

      --accent:#22c55e;   /* emerald */
      --accent2:#06b6d4;  /* cyan */
      --accent3:#8b5cf6;  /* violet */
      --danger:#ef4444;

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 25% -10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(6,182,212,.14), transparent 55%),
        radial-gradient(900px 500px at 20% 95%, rgba(139,92,246,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 16px 14px 92px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 16px 16px;
      border-radius: var(--radius);
      background: linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
      min-width: 0;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size: 20px;
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .statusline{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      font-size: 13px;
      font-weight: 700;
      flex-wrap:wrap;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(34,197,94,.12);
      flex: 0 0 auto;
    }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(34,197,94,.30), rgba(34,197,94,.16));
    }
    .btn.ghost{
      background: rgba(255,255,255,.03);
    }
    .btn.menu{
      display:flex; align-items:center; gap:10px;
      padding: 10px 14px;
    }

    .panel{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--radius);
      background: linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.08) 0 2px, transparent 3px) 0 0/24px 24px;
      opacity:.35;
      pointer-events:none;
      mask-image: linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,0));
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 0 0 auto; }
    .searchWrap{
      display:flex; gap:10px; align-items:center;
      width:100%;
    }
    .search{
      flex: 1 1 auto;
      display:flex;
      padding: 10px 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      font-weight: 700;
    }
    .meta{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      line-height: 1.35;
    }

    .chips{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      font-size: 13px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: background .2s ease, border-color .2s ease, transform .08s ease;
    }
    .chip:active{ transform: scale(.985); }
    .chip.active{
      border-color: rgba(6,182,212,.35);
      background: linear-gradient(180deg, rgba(6,182,212,.18), rgba(6,182,212,.08));
    }
    .chip.active.green{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.20), rgba(34,197,94,.08));
    }
    .chip .miniDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.22);
    }
    .chip.active .miniDot{ background: var(--accent2); }
    .chip.active.green .miniDot{ background: var(--accent); }

    .subpanel{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.15);
    }

    .labelRow{
      display:flex; justify-content:space-between; align-items:center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      margin-bottom: 10px;
    }

    .windowChips{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .wchip{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .wchip.active{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.20), rgba(34,197,94,.08));
    }

    .dateRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 12px;
    }
    select{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 16px;
      font-weight: 900;
      font-size: 14px;
      outline:none;
    }

    .proPanel{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.12);
    }
    .proTitle{
      display:flex; justify-content:space-between; align-items:center;
      font-weight: 950;
      margin-bottom: 10px;
      letter-spacing:.2px;
    }
    .proTitle small{
      color: var(--muted);
      font-weight: 900;
    }
    .proCards{
      display:grid;
      gap:10px;
    }
    .proCard{
      padding: 11px 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .proCard b{ display:block; margin-bottom: 2px; }
    .proCard span{ color: var(--muted); font-weight: 700; font-size: 13px; line-height: 1.25; }

    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .game{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .gameHeader{
      padding: 14px 14px 10px;
      position: relative;
    }

    .gameTop{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }
    .teams{
      font-weight: 950;
      font-size: 18px;
      line-height: 1.15;
      letter-spacing:.15px;
    }
    .sub{
      color: var(--muted);
      margin-top: 6px;
      font-size: 13px;
      font-weight: 750;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badgeLive{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width: 108px;
    }
    .liveTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .liveTag .ldot{
      width:10px; height:10px; border-radius:999px;
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(239,68,68,.12);
    }

    .scorePill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 7px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      font-weight: 950;
      font-size: 13px;
      white-space:nowrap;
    }
    .scorePill .min{
      color: rgba(255,255,255,.80);
      font-weight: 900;
    }

    .pillDate{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.80);
      font-weight: 850;
      font-size: 12px;
      white-space:nowrap;
    }

    .gameActions{
      padding: 0 14px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .gameActions .btn{
      flex: 1 1 140px;
      text-align:center;
      padding: 10px 12px;
      border-radius: 16px;
    }

    /* ‚úÖ v1.9: detalhes colaps√°vel */
    .detailsWrap{ display:none; }
    .detailsWrap.open{ display:block; }

    .miniTabs{
      display:flex;
      gap:10px;
      padding: 10px 14px 12px;
      border-top: 1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(6,182,212,.38);
      background: linear-gradient(180deg, rgba(6,182,212,.18), rgba(6,182,212,.07));
    }

    .tabContent{
      padding: 10px 14px 14px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 650;
      display:none;
    }
    .tabContent.active{ display:block; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.78);
      font-weight: 800;
    }
    .kv b{ color: rgba(255,255,255,.92); }

    .empty{
      padding: 16px;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      text-align:center;
      font-weight: 800;
    }

    .bottomNav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      width: min(760px, calc(100% - 28px));
      padding: 10px;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(12px);
      display:flex;
      gap:10px;
      box-shadow: var(--shadow);
      z-index: 30;
    }
    .navBtn{
      flex: 1 1 0;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .navBtn.active{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.10));
    }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 50;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(760px, calc(100% - 28px));
      margin-bottom: 14px;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: rgba(8,24,24,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid var(--stroke);
    }
    .modalHead b{ font-size: 15px; letter-spacing:.2px; }
    .modalBody{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .menuItem{
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      font-weight: 900;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .menuItem small{ color: var(--muted); font-weight: 750; }

    @media (max-width: 420px){
      .teams{ font-size: 17px; }
      .badgeLive{ min-width: 104px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="title">Radar Jogos PRO</div>
        <div class="statusline">
          <span class="dot" id="onlineDot"></span>
          <span id="onlineTxt">Online</span>
          <span id="verTxt" style="opacity:.9;">v1.9</span>
          <span id="checkTxt" style="opacity:.75;">‚Ä¢ Checagem: ‚Äî</span>
        </div>
      </div>
      <button class="btn menu" id="openMenu">‚Ä¶ Menu</button>
    </div>

    <div class="panel">
      <div class="searchWrap">
        <div class="search">
          <input id="q" type="text" placeholder="Buscar time, liga ou pa√≠s..." autocomplete="off" />
        </div>
        <button class="btn ghost" id="clearBtn">Limpar</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="refreshBtn">Atualizar</button>
        <button class="btn ghost" id="autoBtn">Auto: OFF</button>
      </div>

      <div class="meta" id="meta">
        Carregando‚Ä¶
      </div>

      <div class="chips">
        <div class="chip green" id="chipUpcoming"><span class="miniDot"></span>‚ö° Pr√≥ximos</div>
        <div class="chip" id="chipLive"><span class="miniDot"></span>üî¥ Ao vivo</div>
        <div class="chip" id="chipCalendar"><span class="miniDot"></span>üìÖ Calend√°rio</div>
        <div class="chip" id="chipBrazil"><span class="miniDot"></span>üáßüá∑ Brasil</div>
        <div class="chip" id="chipEurope"><span class="miniDot"></span>üá™üá∫ Europa</div>
        <div class="chip" id="chipAll"><span class="miniDot"></span>üåç Todos</div>
      </div>

      <div class="subpanel">
        <div class="labelRow">
          <span>Janela</span>
          <span id="windowLabel">Pr√≥ximas 24h ‚Ä¢ BRT</span>
        </div>
        <div class="windowChips" id="windowChips"></div>
      </div>

      <div class="subpanel" id="calendarBox" style="display:none;">
        <div class="labelRow">
          <span>Data (BRT)</span>
          <span id="dateBadge">‚Äî</span>
        </div>
        <div class="dateRow">
          <select id="dateSelect"></select>
          <button class="btn ghost" id="applyDateBtn">Aplicar</button>
        </div>
      </div>

      <div class="proPanel">
        <div class="proTitle">
          <div>‚ú® Painel PRO</div>
          <small id="proRight">Janela ativa: 24h ‚Ä¢ Fuso: BRT</small>
        </div>

        <div class="proCards">
          <div class="proCard">
            <b>‚ö° Pr√≥ximos por janela</b>
            <span>Escolha 1‚Äì24h para ver s√≥ o que come√ßa nessa faixa (n√£o mistura com AO VIVO).</span>
          </div>
          <div class="proCard">
            <b>üìä Odds / Mais‚ÄìMenos</b>
            <span>Estimativa local j√° aparece. Com API paga, d√° pra puxar odds reais e mais mercados.</span>
          </div>
          <div class="proCard">
            <b>‚≠ê Favoritos</b>
            <span>Salva jogos/ligas no celular (localStorage). Layout e menu j√° preparados.</span>
          </div>
          <div class="proCard">
            <b>üïò Hist√≥rico</b>
            <span>Funciona: ao tocar em Detalhes, o jogo entra no seu hist√≥rico (localStorage).</span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn ghost" id="scrollTopBtn" style="width:100%;">Voltar pro topo</button>
      </div>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="bottomNav">
    <div class="navBtn active" id="navGames">üóìÔ∏è Jogos</div>
    <div class="navBtn" id="navFav">‚≠ê Favoritos</div>
    <div class="navBtn" id="navHist">üïò Hist√≥rico</div>
  </div>

  <div class="modalOverlay" id="menuOverlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <b>Menu</b>
        <button class="btn ghost" id="closeMenu">Fechar</button>
      </div>
      <div class="modalBody">
        <div class="menuItem" id="menuGoFav">
          <span>‚≠ê Favoritos</span><small>ver salvos</small>
        </div>
        <div class="menuItem" id="menuGoHist">
          <span>üïò Hist√≥rico</span><small>ver tocados</small>
        </div>
        <div class="menuItem" id="menuGoGames">
          <span>üóìÔ∏è Jogos</span><small>lista principal</small>
        </div>
        <div class="menuItem" id="menuAbout">
          <span>‚ÑπÔ∏è Sobre</span><small>vers√£o e fonte</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*********************
     * Radar Jogos PRO - v1.9
     * FIX 1: Ao vivo ‚Äútravado‚Äù (heur√≠stica por tempo desde kickoff)
     * FIX 2: Detalhes colaps√°vel (odds/abas s√≥ aparecem ao abrir)
     *********************/

    const VERSION = "v1.9";
    const TZ = "America/Sao_Paulo"; // BRT
    const LS_KEY = "rjpro_state_v9";

    // ‚úÖ Heur√≠stica: se passou tempo demais do kickoff e est√° ‚Äú90'‚Äù sem FT, tiramos do Ao Vivo.
    // (FREE costuma atrasar status. Isso corrige visualmente.)
    const STALE_LIVE_AFTER_MIN = 125; // 2h05m (ajusta se quiser)
    const LIVE_ELAPSED_CUTOFF = 90;   // 90' travado

    const LIVE_STATUSES = new Set(["1H","2H","HT","ET","BT","P","LIVE","IN_PLAY"]);
    const FINISHED_STATUSES = new Set(["FT","AET","PEN"]);
    const NOT_PLAYING_STATUSES = new Set(["PST","CANC","ABD","SUSP","INT","TBD"]);

    const state = {
      mode: "upcoming",    // upcoming | live | favorites | history
      region: "all",       // brazil | europe | all
      windowH: 24,
      calendarOn: false,
      date: null,          // YYYY-MM-DD (BRT)
      q: "",
      favorites: {},
      history: {},
      auto: false,
      autoEverySec: 60,
    };

    let data = null;
    let allGames = [];
    let autoTimer = null;

    const $ = (id) => document.getElementById(id);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function saveState(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        Object.assign(state, JSON.parse(raw));
      }catch(e){}
    }

    function fmtBrtDate(d){
      return new Intl.DateTimeFormat("pt-BR", { timeZone: TZ, day:"2-digit", month:"2-digit", year:"numeric" }).format(d);
    }
    function fmtBrtTime(d){
      return new Intl.DateTimeFormat("pt-BR", { timeZone: TZ, hour:"2-digit", minute:"2-digit" }).format(d);
    }
    function brtDayKey(d){
      const parts = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(d);
      const y = parts.find(p=>p.type==="year").value;
      const m = parts.find(p=>p.type==="month").value;
      const da = parts.find(p=>p.type==="day").value;
      return `${y}-${m}-${da}`;
    }
    function nowHM(){
      const p = new Intl.DateTimeFormat("pt-BR", { timeZone: TZ, hour:"2-digit", minute:"2-digit" }).formatToParts(new Date());
      const hh = p.find(x=>x.type==="hour")?.value || "00";
      const mm = p.find(x=>x.type==="minute")?.value || "00";
      return `${hh}:${mm}`;
    }
    function setCheck(){ $("checkTxt").textContent = `‚Ä¢ Checagem: ${nowHM()}`; }

    function regionMatch(g){
      const c = (g.country||"").toLowerCase();
      if(state.region==="all") return true;
      if(state.region==="brazil") return c.includes("brazil") || c.includes("brasil");
      if(state.region==="europe"){
        const europeCountries = ["england","scotland","wales","ireland","northern ireland","spain","france","italy","germany","portugal","netherlands","belgium","switzerland","austria","sweden","norway","denmark","finland","iceland","poland","czech","slovakia","hungary","romania","bulgaria","greece","turkey","croatia","serbia","slovenia","ukraine","russia","estonia","latvia","lithuania"];
        if(c.includes("europe")) return true;
        return europeCountries.some(x => c.includes(x));
      }
      return true;
    }
    function qMatch(g){
      const q = (state.q||"").trim().toLowerCase();
      if(!q) return true;
      const hay = `${g.home||""} ${g.away||""} ${g.league||""} ${g.country||""}`.toLowerCase();
      return hay.includes(q);
    }

    function getKickoffMs(g){
      if(typeof g.kickoffTs === "number") return g.kickoffTs;
      if(g.date && g.time){
        const iso = `${g.date}T${g.time}:00-03:00`;
        const d = new Date(iso);
        const ms = d.getTime();
        return Number.isFinite(ms) ? ms : null;
      }
      return null;
    }

    function normStatus(g){ return String(g.status||"").toUpperCase().trim(); }
    function isFinished(g){ return FINISHED_STATUSES.has(normStatus(g)); }
    function isNotPlaying(g){ return NOT_PLAYING_STATUSES.has(normStatus(g)); }

    // ‚úÖ v1.9: remove ‚Äúao vivo‚Äù travado por tempo desde kickoff
    function isStaleLiveByTime(g){
      const k = getKickoffMs(g);
      if(!k) return false;

      const now = Date.now();
      const minutesFromKickoff = (now - k) / 60000;

      const el = (typeof g.elapsed === "number") ? g.elapsed : null;
      const st = normStatus(g);

      // Se n√£o √© status live ‚Äúforte‚Äù e est√° 90‚Äô (ou mais) e j√° passou muito do kickoff: considerar finalizado visualmente
      if(!LIVE_STATUSES.has(st) && el !== null && el >= LIVE_ELAPSED_CUTOFF && minutesFromKickoff >= STALE_LIVE_AFTER_MIN){
        return true;
      }

      return false;
    }

    function isLiveGame(g){
      const st = normStatus(g);

      if(isFinished(g)) return false;
      if(isNotPlaying(g)) return false;

      // trava por tempo ‚Üí nunca live
      if(isStaleLiveByTime(g)) return false;

      if(LIVE_STATUSES.has(st)) return true;

      // se veio marcado como live, ainda checa ‚Äústale‚Äù
      if(g.isLive === true) return true;

      const el = (typeof g.elapsed === "number") ? g.elapsed : null;
      if(el !== null && el > 0) return true;

      return false;
    }

    function liveSortScore(g){
      const st = normStatus(g);
      const el = (typeof g.elapsed === "number") ? g.elapsed : 0;
      if(st==="2H") return 3000 + el;
      if(st==="1H") return 2000 + el;
      if(st==="HT") return 2500;
      if(st==="ET") return 3500 + el;
      if(st==="P")  return 3600;
      if(isLiveGame(g)) return 1500 + el;
      return 0;
    }

    function minutesText(g){
      const st = normStatus(g);
      if(isFinished(g)) return "FT";
      if(isStaleLiveByTime(g)) return "FT"; // ‚úÖ v1.9: se travou, mostra como FT no card
      if(typeof g.elapsed === "number" && g.elapsed > 0) return `${g.elapsed}'`;
      if(st==="HT") return "HT";
      return st || "‚Äî";
    }

    function scoreText(g){
      const sh = (typeof g.scoreHome === "number") ? g.scoreHome : null;
      const sa = (typeof g.scoreAway === "number") ? g.scoreAway : null;
      if(sh===null || sa===null) return null;
      return `${sh}‚Äì${sa}`;
    }

    function gameId(g){
      if(g.id) return String(g.id);
      return `${g.home||""}__${g.away||""}__${g.league||""}__${g.date||""}__${g.time||""}`;
    }

    function setActiveChip(){
      $("chipUpcoming").classList.toggle("active", state.mode==="upcoming");
      $("chipUpcoming").classList.toggle("green", true);
      $("chipLive").classList.toggle("active", state.mode==="live");
      $("chipCalendar").classList.toggle("active", state.calendarOn);

      $("chipBrazil").classList.toggle("active", state.region==="brazil");
      $("chipEurope").classList.toggle("active", state.region==="europe");
      $("chipAll").classList.toggle("active", state.region==="all");

      $("navGames").classList.toggle("active", state.mode==="upcoming" || state.mode==="live");
      $("navFav").classList.toggle("active", state.mode==="favorites");
      $("navHist").classList.toggle("active", state.mode==="history");

      $("autoBtn").textContent = `Auto: ${state.auto ? "ON" : "OFF"}`;
      $("autoBtn").classList.toggle("primary", !!state.auto);
    }

    function renderWindowChips(){
      const opts = [1,2,3,6,12,24];
      const root = $("windowChips");
      root.innerHTML = "";
      for(const h of opts){
        const el = document.createElement("div");
        el.className = "wchip" + (state.windowH===h ? " active":"");
        el.textContent = h + "h";
        el.onclick = () => {
          state.windowH = h;
          $("windowLabel").textContent = `Pr√≥ximas ${h}h ‚Ä¢ BRT`;
          $("proRight").textContent = `Janela ativa: ${h}h ‚Ä¢ Fuso: BRT`;
          saveState();
          renderWindowChips();
          render();
        };
        root.appendChild(el);
      }
      $("windowLabel").textContent = `Pr√≥ximas ${state.windowH}h ‚Ä¢ BRT`;
      $("proRight").textContent = `Janela ativa: ${state.windowH}h ‚Ä¢ Fuso: BRT`;
    }

    function fillDateSelect(){
      const sel = $("dateSelect");
      sel.innerHTML = "";
      const now = new Date();
      const days = [];
      for(let i=0;i<10;i++){
        const d = new Date(now.getTime() + i*24*3600*1000);
        days.push(brtDayKey(d));
      }
      for(const day of days){
        const opt = document.createElement("option");
        opt.value = day;
        const d = new Date(`${day}T12:00:00-03:00`);
        opt.textContent = fmtBrtDate(d);
        sel.appendChild(opt);
      }
      if(!state.date) state.date = days[0];
      sel.value = state.date;
      $("dateBadge").textContent = sel.options[sel.selectedIndex]?.textContent || "‚Äî";
    }

    async function loadJogosJson(force=false){
      const bust = force ? `?t=${Date.now()}` : "";
      const url = "jogos.json" + bust;
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Falha ao carregar jogos.json");
      const j = await res.json();
      data = j;
      allGames = Array.isArray(j.games) ? j.games : [];
    }

    function updateMeta(){
      if(!data){
        $("meta").textContent = "Sem dados ainda.";
        return;
      }
      const upd = data.updatedAt || "‚Äî";
      const src = data.source || "‚Äî";

      const now = Date.now();
      let liveCount=0, todayCount=0, next24=0;

      const todayKey = brtDayKey(new Date());
      for(const g of allGames){
        const k = getKickoffMs(g);
        if(isLiveGame(g)) liveCount++;
        if(g.date === todayKey) todayCount++;
        if(k && k >= now && k <= (now + 24*3600*1000)) next24++;
      }

      $("meta").innerHTML =
        `√öltima atualiza√ß√£o: <b>${upd}</b> ‚Ä¢ Fonte: <b>${src}</b> ‚Ä¢ Auto: <b>${state.auto ? "ON" : "OFF"}</b><br>` +
        `Jogos no arquivo: <b>${allGames.length}</b> ‚Ä¢ Hoje: <b>${todayCount}</b> ‚Ä¢ Pr√≥x 24h: <b>${next24}</b> ‚Ä¢ Ao vivo: <b>${liveCount}</b>`;
    }

    function filterUpcoming(){
      const now = Date.now();
      const max = now + state.windowH * 3600 * 1000;

      return allGames.filter(g => {
        if(!regionMatch(g) || !qMatch(g)) return false;
        if(isLiveGame(g)) return false;
        if(isFinished(g) || isNotPlaying(g)) return false;

        const k = getKickoffMs(g);
        if(!k) return false;

        if(state.calendarOn && state.date){
          if(g.date !== state.date) return false;
          return true;
        }
        return (k >= now && k <= max);
      })
      .sort((a,b) => (getKickoffMs(a)||0) - (getKickoffMs(b)||0));
    }

    function filterLive(){
      return allGames.filter(g => {
        if(!regionMatch(g) || !qMatch(g)) return false;
        if(!isLiveGame(g)) return false;
        return true;
      })
      .sort((a,b) => liveSortScore(b) - liveSortScore(a));
    }

    function renderEmpty(msg){
      $("list").innerHTML = `<div class="empty">${msg}</div>`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function renderGameCard(g){
      const id = gameId(g);
      const live = isLiveGame(g);

      const k = getKickoffMs(g);
      const dStr = g.date ? fmtBrtDate(new Date(`${g.date}T12:00:00-03:00`)) : "‚Äî";
      const tStr = k ? fmtBrtTime(new Date(k)) : (g.time || "‚Äî");

      const score = scoreText(g);
      const mins = minutesText(g);

      const fav = !!state.favorites[id];

      const el = document.createElement("div");
      el.className = "game";

      el.innerHTML = `
        <div class="gameHeader">
          <div class="gameTop">
            <div style="min-width:0">
              <div class="teams">${escapeHtml(g.home||"")} <span style="opacity:.6">x</span> ${escapeHtml(g.away||"")}</div>
              <div class="sub">
                <span>${escapeHtml(g.league||"‚Äî")}</span>
                <span style="opacity:.5">‚Ä¢</span>
                <span>${escapeHtml(g.country||"‚Äî")}</span>
                <span style="opacity:.5">‚Ä¢</span>
                <span><b>${tStr}</b></span>
                <span class="pillDate">${dStr}</span>
              </div>
            </div>

            <div class="badgeLive">
              ${live ? `<div class="liveTag"><span class="ldot"></span>AO VIVO</div>` : ``}
              ${(live || isFinished(g) || isStaleLiveByTime(g)) && (score || mins) ? `
                <div class="scorePill">
                  <span>${score ? score : "‚Äî"}</span>
                  <span class="min">‚Ä¢ ${mins}</span>
                </div>
              ` : ``}
            </div>
          </div>
        </div>

        <div class="gameActions">
          <button class="btn ghost" data-act="details">Detalhes</button>
          <button class="btn ${fav ? "primary":"ghost"}" data-act="fav">${fav ? "‚òÖ Favoritado" : "‚òÜ Favoritar"}</button>
        </div>

        <div class="detailsWrap" data-details>
          <div class="miniTabs" data-tabs>
            <div class="tab active" data-tab="insights">Insights / Odds</div>
            <div class="tab" data-tab="maismenos">Mais/Menos</div>
            <div class="tab" data-tab="forma">Forma</div>
          </div>

          <div class="tabContent active" data-content="insights">
            <div class="grid2">
              <div class="kv"><span>Over 1,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>Under 2,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>Over 2,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>BTTS</span><b>‚Äî%</b></div>
            </div>
            <div style="margin-top:10px; color:rgba(255,255,255,.60); font-weight:700;">
              No modo FREE, alguns c√°lculos podem n√£o aparecer. Layout pronto para a API paga.
            </div>
          </div>

          <div class="tabContent" data-content="maismenos">
            <div class="grid2">
              <div class="kv"><span>Over 0,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>Over 3,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>Under 1,5</span><b>‚Äî%</b></div>
              <div class="kv"><span>Under 3,5</span><b>‚Äî%</b></div>
            </div>
            <div style="margin-top:10px; color:rgba(255,255,255,.60); font-weight:700;">
              Em PRO: odds reais e mercados extras.
            </div>
          </div>

          <div class="tabContent" data-content="forma">
            <div style="display:grid; gap:10px">
              <div class="kv"><span>Forma (casa)</span><b>‚Äî</b></div>
              <div class="kv"><span>Forma (fora)</span><b>‚Äî</b></div>
              <div class="kv"><span>H2H (√∫ltimos)</span><b>‚Äî</b></div>
            </div>
            <div style="margin-top:10px; color:rgba(255,255,255,.60); font-weight:700;">
              Em PRO: √∫ltimos jogos reais e tend√™ncias por liga.
            </div>
          </div>
        </div>
      `;

      // Favoritar
      el.querySelector('[data-act="fav"]').onclick = () => {
        state.favorites[id] = !state.favorites[id];
        saveState();
        render();
      };

      // ‚úÖ v1.9: Detalhes abre/fecha + salva no hist√≥rico quando ABRE
      const detailsBtn = el.querySelector('[data-act="details"]');
      const detailsWrap = el.querySelector('[data-details]');
      let opened = false;

      function setOpened(v){
        opened = v;
        detailsWrap.classList.toggle("open", opened);
        detailsBtn.textContent = opened ? "Fechar" : "Detalhes";
      }

      detailsBtn.onclick = () => {
        setOpened(!opened);
        if(opened){
          state.history[id] = Date.now();
          saveState();
          // opcional: rolar at√© as abas quando abrir
          setTimeout(() => {
            detailsWrap.scrollIntoView({behavior:"smooth", block:"center"});
          }, 60);
        }
      };

      // Tabs (s√≥ quando aberto, mas pode configurar j√°)
      const tabs = el.querySelectorAll(".tab");
      const contents = el.querySelectorAll(".tabContent");
      tabs.forEach(t => {
        t.onclick = () => {
          tabs.forEach(x=>x.classList.remove("active"));
          t.classList.add("active");
          const key = t.getAttribute("data-tab");
          contents.forEach(c=>{
            c.classList.toggle("active", c.getAttribute("data-content")===key);
          });
        };
      });

      // come√ßa fechado sempre (fica mais limpo)
      setOpened(false);

      return el;
    }

    function renderFavorites(){
      const favIds = Object.keys(state.favorites).filter(k => state.favorites[k]);
      if(favIds.length===0){
        renderEmpty("Voc√™ ainda n√£o favoritou nada. Clique em ‚òÜ Favoritar em um jogo.");
        return;
      }
      const map = new Map(allGames.map(g => [gameId(g), g]));
      const favGames = favIds.map(id => map.get(id)).filter(Boolean);

      favGames.sort((a,b) => {
        const la = isLiveGame(a), lb = isLiveGame(b);
        if(la && !lb) return -1;
        if(lb && !la) return 1;
        if(la && lb) return liveSortScore(b)-liveSortScore(a);
        return (getKickoffMs(a)||0) - (getKickoffMs(b)||0);
      });

      const root = $("list");
      root.innerHTML = "";
      favGames.forEach(g => root.appendChild(renderGameCard(g)));
    }

    function renderHistory(){
      const ids = Object.keys(state.history || {});
      if(ids.length===0){
        renderEmpty("Seu hist√≥rico est√° vazio. Abra ‚ÄúDetalhes‚Äù em um jogo para salvar aqui.");
        return;
      }
      const map = new Map(allGames.map(g => [gameId(g), g]));
      const items = ids
        .map(id => ({ id, ts: state.history[id], g: map.get(id) }))
        .filter(x => x.g)
        .sort((a,b) => (b.ts||0) - (a.ts||0));

      const root = $("list");
      root.innerHTML = "";
      items.forEach(x => root.appendChild(renderGameCard(x.g)));
    }

    function render(){
      $("verTxt").textContent = VERSION;
      setActiveChip();
      updateMeta();

      $("calendarBox").style.display = state.calendarOn ? "block" : "none";
      if(state.calendarOn){
        fillDateSelect();
        $("dateSelect").value = state.date || $("dateSelect").value;
        $("dateBadge").textContent = $("dateSelect").options[$("dateSelect").selectedIndex]?.textContent || "‚Äî";
      }

      if(state.mode==="favorites"){ renderFavorites(); return; }
      if(state.mode==="history"){ renderHistory(); return; }

      if(!data){
        renderEmpty("Sem dados ainda. Clique em Atualizar.");
        return;
      }

      let list = [];
      if(state.mode==="live"){
        list = filterLive();
        if(list.length===0){
          renderEmpty("Nada ao vivo agora com esses filtros. Troque regi√£o ou use Pr√≥ximos.");
          return;
        }
      } else {
        list = filterUpcoming();
        if(list.length===0){
          const hint = state.calendarOn ? "N√£o h√° jogos nessa data com esses filtros." : "Sem jogos nessa janela. Tente 12h/24h ou ative Calend√°rio.";
          renderEmpty(hint);
          return;
        }
      }

      const root = $("list");
      root.innerHTML = "";
      list.forEach(g => root.appendChild(renderGameCard(g)));
    }

    function startAuto(){
      stopAuto();
      autoTimer = setInterval(async () => {
        try{
          await loadJogosJson(true);
          setCheck();
          updateMeta();
          render();
        }catch(e){}
      }, clamp(state.autoEverySec||60, 15, 300) * 1000);
    }
    function stopAuto(){
      if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
      }
    }

    function wire(){
      $("chipUpcoming").onclick = () => { state.mode="upcoming"; saveState(); render(); };
      $("chipLive").onclick = () => { state.mode="live"; state.calendarOn=false; saveState(); render(); };

      $("chipCalendar").onclick = () => {
        state.calendarOn = !state.calendarOn;
        if(state.calendarOn) state.mode="upcoming";
        saveState();
        render();
      };

      $("chipBrazil").onclick = () => { state.region="brazil"; saveState(); render(); };
      $("chipEurope").onclick = () => { state.region="europe"; saveState(); render(); };
      $("chipAll").onclick = () => { state.region="all"; saveState(); render(); };

      $("q").addEventListener("input", () => {
        state.q = $("q").value;
        saveState();
        render();
      });

      $("clearBtn").onclick = () => {
        state.q = "";
        $("q").value = "";
        saveState();
        render();
      };

      $("refreshBtn").onclick = async () => {
        $("refreshBtn").textContent = "Atualizando‚Ä¶";
        try{
          await loadJogosJson(true);
          setCheck();
          updateMeta();
          render();
        }catch(e){
          renderEmpty("Erro ao atualizar dados. Veja se o workflow gerou jogos.json e se o link est√° p√∫blico.");
        }finally{
          $("refreshBtn").textContent = "Atualizar";
        }
      };

      $("autoBtn").onclick = async () => {
        state.auto = !state.auto;
        saveState();
        setActiveChip();
        updateMeta();

        if(state.auto){
          try{ await loadJogosJson(true); setCheck(); }catch(e){}
          startAuto();
          render();
        } else {
          stopAuto();
        }
      };

      $("scrollTopBtn").onclick = () => window.scrollTo({top:0, behavior:"smooth"});

      $("applyDateBtn").onclick = () => {
        state.date = $("dateSelect").value;
        saveState();
        render();
      };

      $("dateSelect").addEventListener("change", () => {
        state.date = $("dateSelect").value;
        saveState();
        render();
      });

      $("navGames").onclick = () => {
        if(state.mode==="favorites" || state.mode==="history") state.mode="upcoming";
        saveState(); render();
      };
      $("navFav").onclick = () => { state.mode="favorites"; saveState(); render(); };
      $("navHist").onclick = () => { state.mode="history"; saveState(); render(); };

      $("openMenu").onclick = () => $("menuOverlay").classList.add("show");
      $("closeMenu").onclick = () => $("menuOverlay").classList.remove("show");
      $("menuOverlay").onclick = (e) => { if(e.target === $("menuOverlay")) $("menuOverlay").classList.remove("show"); };

      $("menuGoFav").onclick = () => { state.mode="favorites"; saveState(); render(); $("menuOverlay").classList.remove("show"); };
      $("menuGoHist").onclick = () => { state.mode="history"; saveState(); render(); $("menuOverlay").classList.remove("show"); };
      $("menuGoGames").onclick = () => { state.mode="upcoming"; saveState(); render(); $("menuOverlay").classList.remove("show"); };
      $("menuAbout").onclick = () => {
        const upd = data?.updatedAt || "‚Äî";
        const src = data?.source || "‚Äî";
        alert(`Radar Jogos PRO ${VERSION}\nFonte: ${src}\n√öltima atualiza√ß√£o: ${upd}\n\nBRT: ${TZ}`);
      };
    }

    (async function init(){
      loadState();

      state.windowH = clamp(state.windowH || 24, 1, 24);
      if(!state.mode) state.mode = "upcoming";
      if(!state.region) state.region = "all";
      if(!state.favorites) state.favorites = {};
      if(!state.history) state.history = {};
      state.auto = !!state.auto;

      $("q").value = state.q || "";
      $("verTxt").textContent = VERSION;

      renderWindowChips();
      fillDateSelect();
      wire();
      setActiveChip();
      setCheck();

      try{ await loadJogosJson(false); }catch(e){}
      updateMeta();
      render();

      if(state.auto) startAuto();
    })();
  </script>
</body>
  </html>
