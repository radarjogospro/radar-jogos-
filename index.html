<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Radar Jogos PRO</title>
  <meta name="theme-color" content="#0b1b1d" />
  <style>
    :root{
      --bg0:#071416;
      --bg1:#0b1b1d;
      --card:rgba(10,20,25,.55);
      --card2:rgba(255,255,255,.05);
      --bd:rgba(255,255,255,.08);
      --bd2:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.70);
      --mut2:rgba(255,255,255,.55);
      --green:#34c759;
      --red:#ff3b30;
      --blue:#0a84ff;
      --amber:#ffcc00;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r: 22px;
      --r2: 16px;
      --pad: 14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(46, 255, 225, .14), transparent 55%),
        radial-gradient(900px 500px at 90% 15%, rgba(10, 132, 255, .16), transparent 55%),
        radial-gradient(900px 700px at 60% 110%, rgba(52, 199, 89, .12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 14px 14px 120px;
    }

    .topbar{
      margin-top: 8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 26px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }

    .statusdot{
      width:12px;height:12px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 0 6px rgba(52,199,89,.14);
      flex:0 0 auto;
    }

    .brandtext{min-width:0}
    .brandtext .t1{
      font-weight: 850;
      font-size: 20px;
      letter-spacing:.2px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 62vw;
    }
    .brandtext .t2{
      margin-top: 2px;
      font-size: 13px;
      color: var(--mut);
      display:flex;
      align-items:center;
      gap: 6px;
    }

    .menuBtn{
      appearance:none;border:0;outline:0;
      cursor:pointer;
      padding: 11px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 750;
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .menuBtn:active{transform:translateY(1px)}

    .panel{
      margin-top: 14px;
      padding: 14px;
      border-radius: 22px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      backdrop-filter: blur(12px);
      position: relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(255,255,255,.09) 1px, transparent 1px);
      background-size: 18px 18px;
      opacity:.25;
      pointer-events:none;
    }
    .panel > *{position:relative}

    .searchRow{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .search{
      flex:1;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.09);
      color: var(--txt);
      outline:none;
      font-size: 14px;
    }
    .btn{
      appearance:none;border:0;outline:0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--txt);
      font-weight: 800;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}

    .btnPrimary{
      background: linear-gradient(135deg, rgba(52,199,89,.95), rgba(34,166,73,.92));
      border: 1px solid rgba(52,199,89,.35);
      color: rgba(0,0,0,.88);
      font-weight: 900;
    }

    .meta{
      margin-top: 10px;
      font-size: 13px;
      color: var(--mut);
      line-height:1.35;
    }

    .pills{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.09);
      color: var(--txt);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.18);
    }
    .pill.active{
      background: rgba(10,132,255,.10);
      border-color: rgba(10,132,255,.22);
    }
    .pill.active .dot{background: var(--blue); box-shadow: 0 0 0 6px rgba(10,132,255,.14)}
    .pill.red.active{background: rgba(255,59,48,.10); border-color: rgba(255,59,48,.22)}
    .pill.red.active .dot{background: var(--red); box-shadow: 0 0 0 6px rgba(255,59,48,.14)}
    .pill.green.active{background: rgba(52,199,89,.10); border-color: rgba(52,199,89,.22)}
    .pill.green.active .dot{background: var(--green); box-shadow: 0 0 0 6px rgba(52,199,89,.14)}

    .subpills{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }

    .windowBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.06);
    }
    .windowRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: var(--mut);
      font-size: 13px;
      margin-bottom: 10px;
    }
    .chips{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .chipBtn{
      cursor:pointer;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.09);
      color: var(--txt);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
    }
    .chipBtn.active{
      background: rgba(52,199,89,.12);
      border-color: rgba(52,199,89,.22);
    }

    .proPanel{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
    }
    .proHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .proHead .ttl{
      font-weight: 950;
      letter-spacing:.2px;
    }
    .proHead .sub{
      color: var(--mut);
      font-size: 13px;
      font-weight: 750;
    }
    .proCard{
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      margin-top: 10px;
    }
    .proCard .h{
      font-weight: 950;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .proCard .p{
      color: var(--mut);
      font-size: 13px;
      line-height: 1.35;
    }

    .dateRow{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.06);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .dateRow .lbl{color: var(--mut); font-size:13px; font-weight: 800;}
    .dateRow .controls{display:flex; gap:10px; align-items:center; flex:1; justify-content:flex-end;}
    .datePick{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--txt);
      outline:none;
      font-weight: 850;
      max-width: 190px;
    }

    /* LISTA / CARDS */
    #games{
      margin-top: 16px;
    }
    .game-card{
      margin: 12px 0;
      border-radius: 18px;
      padding: 12px;
      background: rgba(10,20,25,.50);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
    }
    .gc-head{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .gc-left{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      min-width: 0;
      flex:1;
    }
    .dotLive{
      width:9px; height:9px; border-radius:999px;
      background: rgba(255,255,255,.18);
      margin-top: 7px;
      flex:0 0 auto;
    }
    .dotLive.live{
      background: var(--red);
      box-shadow: 0 0 0 6px rgba(255,59,48,.14);
    }
    .teams{min-width:0; flex:1}
    .teams .t1{
      font-size: 18px;
      font-weight: 950;
      line-height: 1.12;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }
    .teams .t2{
      margin-top: 6px;
      font-size: 12.5px;
      color: var(--mut);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }
    .gc-right{
      text-align:right;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 6px;
      flex:0 0 auto;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight: 900;
    }
    .chip.live{background: rgba(255,59,48,.10); border-color: rgba(255,59,48,.22)}
    .chip.ft{background: rgba(52,199,89,.10); border-color: rgba(52,199,89,.22)}
    .chip.time{background: rgba(10,132,255,.10); border-color: rgba(10,132,255,.22)}
    .dateMini{font-size: 12px; color: var(--mut)}

    .gc-actions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btnGhost{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--txt);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .btnGhost:active{transform:translateY(1px)}

    details.gc-more{ margin-top: 10px; }
    details.gc-more summary{
      list-style:none;
      cursor:pointer;
      font-weight: 950;
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--txt);
      user-select:none;
    }
    details.gc-more summary::-webkit-details-marker{display:none}

    .mk-box{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.06);
    }
    .mk-row{display:flex; justify-content:space-between; gap:10px; padding: 6px 0;}
    .mk-l{font-size: 13px; color: var(--txt); font-weight: 850;}
    .mk-r{font-size: 13px; color: var(--txt); display:flex; gap:10px; align-items:center;}
    .mk-odd{
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
    }
    .mk-foot{
      margin-top: 10px;
      font-size: 12px;
      color: var(--mut);
      line-height:1.35;
    }

    .empty{
      margin: 14px 0;
      padding: 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--mut);
      line-height:1.4;
    }

    /* MENU (bottom sheet) */
    .sheetBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events:none;
      transition: .18s ease;
      z-index: 50;
    }
    .sheetBack.open{opacity:1; pointer-events:auto;}

    .sheet{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: -520px;
      width: min(860px, calc(100vw - 18px));
      background: rgba(10,20,25,.86);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      border-radius: 26px;
      padding: 12px;
      transition: .22s ease;
      z-index: 51;
    }
    .sheet.open{bottom: 12px;}

    .sheetHandle{
      width: 46px; height: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      margin: 6px auto 12px;
    }
    .sheetTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 8px 12px;
    }
    .sheetTitle .t{font-weight: 950;}
    .sheetTitle .x{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
    }
    .sheetGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .sheetItem{
      cursor:pointer;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.09);
      display:flex;
      align-items:flex-start;
      gap: 12px;
      user-select:none;
    }
    .sheetItem:active{transform: translateY(1px)}
    .sheetItem .ico{
      width: 38px; height: 38px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 18px;
      flex:0 0 auto;
    }
    .sheetItem .tx .h{font-weight: 950; margin-bottom: 4px;}
    .sheetItem .tx .p{color: var(--mut); font-size: 13px; line-height:1.35;}

    /* BOTTOM NAV */
    .nav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10px;
      width: min(860px, calc(100vw - 18px));
      background: rgba(10,20,25,.78);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 28px;
      padding: 10px;
      display:flex;
      gap: 10px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      z-index: 40;
    }
    .navBtn{
      flex:1;
      cursor:pointer;
      user-select:none;
      padding: 12px 12px;
      border-radius: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--txt);
    }
    .navBtn.active{
      background: rgba(52,199,89,.18);
      border-color: rgba(52,199,89,.22);
    }

    @media (min-width: 700px){
      .teams .t1,.teams .t2{max-width: 520px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="toprow">
        <div class="brand">
          <div class="statusdot" id="onlineDot"></div>
          <div class="brandtext">
            <div class="t1">Radar Jogos PRO</div>
            <div class="t2"><span id="onlineText">Online</span></div>
          </div>
        </div>
        <button class="menuBtn" id="btnMenu">‚Ä¶ Menu</button>
      </div>

      <div class="panel">
        <div class="searchRow">
          <input class="search" id="search" placeholder="Buscar time, liga ou pa√≠s..." autocomplete="off" />
          <button class="btn" id="btnClear">Limpar</button>
        </div>

        <div class="pills">
          <div class="pill green active" id="pillLiveUpcoming" data-mode="live+upcoming">
            <span class="dot"></span> ‚ö° Ao vivo + Pr√≥ximos
          </div>
          <div class="pill red" id="pillLive" data-mode="live">
            <span class="dot"></span> üî¥ Ao vivo
          </div>
        </div>

        <div class="subpills">
          <div class="pill active" id="pillCalendar" data-mode="calendar">
            <span class="dot"></span> üìÖ Calend√°rio
          </div>
          <div class="pill" id="pillBrazil" data-country="Brazil">
            <span class="dot"></span> üáßüá∑ Brasil
          </div>
          <div class="pill" id="pillEurope" data-country="Europe">
            <span class="dot"></span> üá™üá∫ Europa
          </div>
          <div class="pill" id="pillAll" data-country="all">
            <span class="dot"></span> üåé Todos
          </div>
        </div>

        <div class="windowBox">
          <div class="windowRow">
            <div class="lbl">Janela</div>
            <div id="windowInfo">Pr√≥ximas 24h ‚Ä¢ BRT</div>
          </div>
          <div class="chips" id="windowChips">
            <div class="chipBtn" data-hours="1">1h</div>
            <div class="chipBtn" data-hours="2">2h</div>
            <div class="chipBtn" data-hours="3">3h</div>
            <div class="chipBtn" data-hours="6">6h</div>
            <div class="chipBtn" data-hours="12">12h</div>
            <div class="chipBtn active" data-hours="24">24h</div>
          </div>
        </div>

        <div class="dateRow">
          <div class="lbl">Data (BRT)</div>
          <div class="controls">
            <input class="datePick" id="datePicker" type="date" />
            <button class="btn" id="btnApplyDate">Aplicar</button>
          </div>
        </div>

        <div class="proPanel">
          <div class="proHead">
            <div class="ttl">‚ú® Painel PRO</div>
            <div class="sub" id="proSub">Janela ativa: 24h ‚Ä¢ Fuso: BRT</div>
          </div>

          <div class="proCard">
            <div class="h">‚ö° Pr√≥ximos por janela</div>
            <div class="p">Escolha 1‚Äì24h para ver s√≥ o que come√ßa nessa faixa (AO VIVO continua no topo).</div>
          </div>

          <div class="proCard">
            <div class="h">üìä Odds / Mais-Menoss</div>
            <div class="p">Estimativa local j√° aparece. Com API paga, d√° pra puxar odds reais e mais mercados.</div>
          </div>

          <div class="proCard">
            <div class="h">‚≠ê Favoritos</div>
            <div class="p">Salva jogos que voc√™ acompanha (localStorage). Layout e menu j√° preparados.</div>
          </div>

          <div class="proCard">
            <div class="h">üïò Hist√≥rico</div>
            <div class="p">Marca jogos vistos e revisa depois (localStorage). √ìtimo pra rotina di√°ria.</div>
          </div>
        </div>

        <div class="meta">
          <button class="btn btnPrimary" id="btnRefresh">Atualizar</button>
          <div style="margin-top:10px" id="metaLine">
            √öltima atualiza√ß√£o: ‚Äî ‚Ä¢ Fonte: ‚Äî<br/>
            Jogos no arquivo: ‚Äî ‚Ä¢ Hoje: ‚Äî ‚Ä¢ Pr√≥x 24h: ‚Äî ‚Ä¢ Ao vivo: ‚Äî
          </div>
        </div>
      </div>
    </div>

    <div id="games"></div>
  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <div class="navBtn active" id="navGames">üóìÔ∏è Jogos</div>
    <div class="navBtn" id="navFavs">‚òÖ Favoritos</div>
    <div class="navBtn" id="navHist">‚è± Hist√≥rico</div>
  </div>

  <!-- Menu sheet -->
  <div class="sheetBack" id="sheetBack"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHandle"></div>
    <div class="sheetTitle">
      <div class="t">Menu</div>
      <button class="x" id="sheetClose">Fechar</button>
    </div>
    <div class="sheetGrid">
      <div class="sheetItem" data-go="favs">
        <div class="ico">‚òÖ</div>
        <div class="tx">
          <div class="h">Favoritos</div>
          <div class="p">Ver e gerenciar seus jogos salvos.</div>
        </div>
      </div>
      <div class="sheetItem" data-go="hist">
        <div class="ico">‚è±</div>
        <div class="tx">
          <div class="h">Hist√≥rico</div>
          <div class="p">Revisar jogos marcados como vistos.</div>
        </div>
      </div>
      <div class="sheetItem" data-go="config">
        <div class="ico">‚öôÔ∏è</div>
        <div class="tx">
          <div class="h">Configura√ß√µes</div>
          <div class="p">BRT, janela, limpeza de dados e modo PRO.</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // ============ CONFIG ============
  const TZ = "America/Sao_Paulo";
  const DATA_URL = "./jogos.json?v=" + Date.now();
  const PAGE_SIZE = 30;
  const OU_LINES = [1.5, 2.5, 3.5];
  const TEAM_FT_SAMPLE = 6;

  // ============ DOM ============
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const el = {
    games: $("#games"),
    metaLine: $("#metaLine"),
    btnRefresh: $("#btnRefresh"),
    btnClear: $("#btnClear"),
    search: $("#search"),
    datePicker: $("#datePicker"),
    btnApplyDate: $("#btnApplyDate"),
    windowInfo: $("#windowInfo"),
    proSub: $("#proSub"),
    windowChips: $("#windowChips"),

    pills: {
      liveUpcoming: $("#pillLiveUpcoming"),
      live: $("#pillLive"),
      calendar: $("#pillCalendar"),
      brazil: $("#pillBrazil"),
      europe: $("#pillEurope"),
      all: $("#pillAll"),
    },

    nav: {
      games: $("#navGames"),
      favs: $("#navFavs"),
      hist: $("#navHist"),
    },

    sheet: {
      btn: $("#btnMenu"),
      back: $("#sheetBack"),
      sheet: $("#sheet"),
      close: $("#sheetClose"),
      items: $$(".sheetItem"),
    }
  };

  // ============ STATE ============
  const state = {
    data: null,
    games: [],
    gamesByDate: new Map(),
    liveGames: [],
    upcomingSorted: [],
    ftByTeam: new Map(),

    view: "games", // games | favs | hist | config
    filter: {
      mode: "live+upcoming", // live+upcoming | live | calendar
      country: "all",        // all | Brazil | Europe
      q: "",
      windowHours: 24,
      dateKey: null,         // YYYY-MM-DD
    },

    render: {
      page: 1,
      list: [],
      lastHash: "",
    }
  };

  // ============ STORAGE ============
  const LS_FAV = "rjp_favs";
  const LS_HIST = "rjp_hist";

  const getSet = (k) => new Set(JSON.parse(localStorage.getItem(k) || "[]"));
  const saveSet = (k, set) => localStorage.setItem(k, JSON.stringify(Array.from(set)));

  // ============ HELPERS ============
  const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
  const normalizeText = (s) => (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();

  function fmtBrtDate(ts){
    try { return new Intl.DateTimeFormat("pt-BR",{timeZone:TZ,day:"2-digit",month:"2-digit",year:"numeric"}).format(new Date(ts)); }
    catch { return "‚Äî"; }
  }
  function fmtBrtTime(ts){
    try { return new Intl.DateTimeFormat("pt-BR",{timeZone:TZ,hour:"2-digit",minute:"2-digit"}).format(new Date(ts)); }
    catch { return "‚Äî"; }
  }
  function todayKeyBRT(){
    return new Intl.DateTimeFormat("en-CA",{timeZone:TZ}).format(new Date());
  }

  function isEurope(countryStr){
    const c = normalizeText(countryStr);
    return ["england","spain","italy","france","germany","portugal","netherlands","belgium","turkey","greece",
            "scotland","wales","ireland","sweden","norway","denmark","finland","poland","austria","switzerland",
            "czech","slovakia","hungary","romania","bulgaria","croatia","serbia","slovenia","ukraine","russia",
            "moldova","iceland","latvia","lithuania","estonia"].some(x => c.includes(x));
  }

  // ============ POISSON ============
  function poissonPMF(k, lambda){
    let fact=1;
    for(let i=2;i<=k;i++) fact*=i;
    return Math.exp(-lambda)*Math.pow(lambda,k)/fact;
  }
  function poissonCDF(k, lambda){
    let sum=0;
    for(let i=0;i<=k;i++) sum += poissonPMF(i, lambda);
    return sum;
  }
  function probOver(line, lambda){
    const k = Math.floor(line);
    return 1 - poissonCDF(k, lambda);
  }
  function probUnder(line, lambda){
    const k = Math.floor(line);
    return poissonCDF(k, lambda);
  }
  function fairOdd(p){ return (!p || p<=0) ? null : (1/p); }
  function pct(p){ return (p==null || Number.isNaN(p)) ? "‚Äî" : (Math.round(p*100)+"%"); }
  function oddStr(o){ return (!o || !Number.isFinite(o)) ? "‚Äî" : o.toFixed(2); }

  function estimateLambdaTotal(home, away){
    const a = state.ftByTeam.get(home) || [];
    const b = state.ftByTeam.get(away) || [];
    const sample = a.concat(b);
    if(sample.length < 4) return null;
    const avg = sample.reduce((acc,x)=>acc+(x.totalGoals||0),0)/sample.length;
    return clamp(avg, 0.6, 4.2);
  }

  function buildMarkets(game){
    const lambda = estimateLambdaTotal(game.home, game.away);
    return OU_LINES.map(line=>{
      if(!lambda) return {line, overP:null, underP:null, overOdd:null, underOdd:null};
      const overP = probOver(line, lambda);
      const underP = probUnder(line, lambda);
      return {line, overP, underP, overOdd: fairOdd(overP), underOdd: fairOdd(underP)};
    });
  }

  // ============ DATA / INDEXES ============
  async function loadData(){
    const res = await fetch(DATA_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("Falha ao carregar jogos.json");
    return await res.json();
  }

  function buildIndexes(games){
    state.gamesByDate.clear();
    state.liveGames = [];
    state.upcomingSorted = [];
    state.ftByTeam.clear();

    for(const g of games){
      // kickoffTs
      let kickoff = g.kickoffTs;
      if(!kickoff && g.date && g.time){
        // tenta montar com -03:00
        kickoff = Date.parse(`${g.date}T${g.time}:00-03:00`);
      }
      g.kickoffTs = kickoff || null;

      const dateKey = g.date || (g.kickoffTs ? new Intl.DateTimeFormat("en-CA",{timeZone:TZ}).format(new Date(g.kickoffTs)) : null);
      g._dateKey = dateKey;

      g._isLive = !!g.isLive || g.status==="LIVE" || g.status==="1H" || g.status==="2H";
      g._isFT = g.status==="FT" || g.status==="AET" || g.status==="PEN";

      if(dateKey){
        if(!state.gamesByDate.has(dateKey)) state.gamesByDate.set(dateKey, []);
        state.gamesByDate.get(dateKey).push(g);
      }

      if(g._isLive) state.liveGames.push(g);

      if(g.kickoffTs && !g._isLive) state.upcomingSorted.push(g);

      if(g._isFT){
        const totalGoals = (Number(g.scoreHome)||0)+(Number(g.scoreAway)||0);
        const ts = g.kickoffTs || 0;
        for(const t of [g.home, g.away].filter(Boolean)){
          const key = t.trim();
          if(!state.ftByTeam.has(key)) state.ftByTeam.set(key, []);
          state.ftByTeam.get(key).push({ts, totalGoals});
        }
      }
    }

    for(const [k,arr] of state.gamesByDate.entries()){
      arr.sort((a,b)=>(a.kickoffTs||0)-(b.kickoffTs||0));
    }
    state.upcomingSorted.sort((a,b)=>(a.kickoffTs||0)-(b.kickoffTs||0));
    state.liveGames.sort((a,b)=>(b.elapsed||0)-(a.elapsed||0));

    for(const [team,arr] of state.ftByTeam.entries()){
      arr.sort((a,b)=>b.ts-a.ts);
      state.ftByTeam.set(team, arr.slice(0, TEAM_FT_SAMPLE));
    }
  }

  // ============ FILTERS ============
  function passCountry(g){
    const c = state.filter.country;
    if(c==="all") return true;
    if(c==="Brazil") return normalizeText(g.country)==="brazil";
    if(c==="Europe") return isEurope(g.country);
    return true;
  }
  function passSearch(g){
    const q = state.filter.q;
    if(!q) return true;
    const hay = normalizeText(`${g.home} ${g.away} ${g.league} ${g.country}`);
    return hay.includes(q);
  }

  function getFilteredList(){
    const f = state.filter;
    let base = [];

    if(f.mode==="live"){
      base = state.liveGames;
    } else if(f.mode==="calendar"){
      const dk = f.dateKey;
      base = dk && state.gamesByDate.has(dk) ? state.gamesByDate.get(dk) : [];
    } else {
      // live+upcoming
      const now = Date.now();
      const max = now + f.windowHours*3600*1000;
      const upcoming = [];
      for(const g of state.upcomingSorted){
        const ts = g.kickoffTs || 0;
        if(ts < now) continue;
        if(ts > max) break;
        upcoming.push(g);
      }
      base = state.liveGames.concat(upcoming);
    }

    const out = [];
    for(const g of base){
      if(!passCountry(g)) continue;
      if(!passSearch(g)) continue;
      out.push(g);
    }

    // live topo
    out.sort((a,b)=>{
      if(a._isLive && !b._isLive) return -1;
      if(!a._isLive && b._isLive) return 1;
      return (a.kickoffTs||0)-(b.kickoffTs||0);
    });

    return out;
  }

  // ============ UI RENDER ============
  function scoreChip(g){
    const hs = (g.scoreHome ?? "‚Äî");
    const as = (g.scoreAway ?? "‚Äî");
    const score = `${hs}\u2013${as}`;

    if(g._isLive){
      const elp = Number(g.elapsed);
      const min = Number.isFinite(elp) && elp>0 ? `${elp}'` : "AO VIVO";
      return `<span class="chip live">${score} <span style="opacity:.7">‚Ä¢</span> ${min}</span>`;
    }
    if(g._isFT){
      return `<span class="chip ft">${score} <span style="opacity:.7">‚Ä¢</span> FT</span>`;
    }
    return `<span class="chip time">${fmtBrtTime(g.kickoffTs || Date.now())}</span>`;
  }

  function renderCard(g){
    const dateLabel = g.kickoffTs ? fmtBrtDate(g.kickoffTs) : (g.date || "‚Äî");
    const meta = `${g.league||"‚Äî"} ‚Ä¢ ${g.country||"‚Äî"} ‚Ä¢ ${fmtBrtTime(g.kickoffTs || Date.now())}`;
    const dotCls = g._isLive ? "dotLive live" : "dotLive";

    const favs = getSet(LS_FAV);
    const isFav = favs.has(String(g.id||""));
    const favTxt = isFav ? "‚òÖ Favoritado" : "‚òÖ Favoritar";

    const mk = buildMarkets(g);
    const rows = mk.map(m=>`
      <div class="mk-row"><div class="mk-l">Over ${m.line}</div><div class="mk-r">${pct(m.overP)} <span class="mk-odd">${oddStr(m.overOdd)}</span></div></div>
      <div class="mk-row"><div class="mk-l">Under ${m.line}</div><div class="mk-r">${pct(m.underP)} <span class="mk-odd">${oddStr(m.underOdd)}</span></div></div>
    `).join("");

    return `
      <article class="game-card">
        <header class="gc-head">
          <div class="gc-left">
            <div class="${dotCls}"></div>
            <div class="teams">
              <div class="t1">${g.home||"‚Äî"} <span style="opacity:.7">x</span> ${g.away||"‚Äî"}</div>
              <div class="t2">${meta}</div>
            </div>
          </div>
          <div class="gc-right">
            ${scoreChip(g)}
            <div class="dateMini">${dateLabel}</div>
          </div>
        </header>

        <div class="gc-actions">
          <button class="btnGhost" data-action="details">Detalhes</button>
          <button class="btnGhost" data-action="fav" data-id="${String(g.id||"")}">${favTxt}</button>
          <button class="btnGhost" data-action="seen" data-id="${String(g.id||"")}">Marcar visto</button>
        </div>

        <details class="gc-more">
          <summary>Insights / Odds</summary>
          <div class="mk-box">
            ${rows}
            <div class="mk-foot">
              Estimativa local (FREE). Com API paga: odds reais, + mercados e mais precis√£o.
            </div>
          </div>
        </details>
      </article>
    `;
  }

  function renderEmpty(msg){
    el.games.innerHTML = `<div class="empty">${msg}</div>`;
  }

  function renderList(){
    if(state.view==="favs") return renderFavs();
    if(state.view==="hist") return renderHist();
    if(state.view==="config") return renderConfig();

    const list = getFilteredList();
    state.render.list = list;

    const total = list.length;
    const page = clamp(state.render.page, 1, Math.ceil(total/PAGE_SIZE)||1);
    state.render.page = page;
    const shown = list.slice(0, page*PAGE_SIZE);

    const hash = `${state.view}|${state.filter.mode}|${state.filter.country}|${state.filter.q}|${state.filter.windowHours}|${state.filter.dateKey}|${page}|${total}`;
    if(hash === state.render.lastHash) return;
    state.render.lastHash = hash;

    if(!total){
      return renderEmpty("Nenhum jogo encontrado com esses filtros. Tente mudar a janela (1h/24h), pa√≠s ou buscar outro termo.");
    }

    const html = shown.map(renderCard).join("");
    const canMore = shown.length < total;
    const more = canMore ? `<button class="btn" id="btnMore" style="margin: 14px 0 90px;">Carregar mais (${shown.length}/${total})</button>` : `<div style="height:90px"></div>`;
    el.games.innerHTML = html + more;

    const btnMore = $("#btnMore");
    if(btnMore){
      btnMore.addEventListener("click", () => {
        state.render.page += 1;
        renderList();
      }, { once:true });
    }
  }

  function renderFavs(){
    const favs = getSet(LS_FAV);
    const ids = new Set(Array.from(favs));
    const list = state.games.filter(g => ids.has(String(g.id||"")));
    list.sort((a,b)=> (b.kickoffTs||0)-(a.kickoffTs||0));

    if(!list.length){
      return renderEmpty("Voc√™ ainda n√£o favoritou nenhum jogo. Toque em <b>‚òÖ Favoritar</b> em algum card.");
    }

    el.games.innerHTML = `
      <div class="empty"><b>Favoritos</b><br/><span style="color:rgba(255,255,255,.7)">Seus jogos salvos (localStorage).</span></div>
      ${list.map(renderCard).join("")}
      <div style="height:90px"></div>
    `;
  }

  function renderHist(){
    const hist = getSet(LS_HIST);
    const ids = new Set(Array.from(hist));
    const list = state.games.filter(g => ids.has(String(g.id||"")));
    list.sort((a,b)=> (b.kickoffTs||0)-(a.kickoffTs||0));

    if(!list.length){
      return renderEmpty("Seu hist√≥rico est√° vazio. Use <b>Marcar visto</b> em algum jogo.");
    }

    el.games.innerHTML = `
      <div class="empty"><b>Hist√≥rico</b><br/><span style="color:rgba(255,255,255,.7)">Jogos marcados como vistos (localStorage).</span></div>
      ${list.map(renderCard).join("")}
      <div style="height:90px"></div>
    `;
  }

  function renderConfig(){
    el.games.innerHTML = `
      <div class="empty">
        <b>Configura√ß√µes</b><br/>
        <span style="color:rgba(255,255,255,.7)">
          Tudo aqui √© local (no seu celular).<br/><br/>
          <button class="btn" id="btnClearFav">Limpar Favoritos</button>
          <button class="btn" id="btnClearHist" style="margin-left:10px">Limpar Hist√≥rico</button>
        </span>
      </div>
      <div style="height:90px"></div>
    `;

    const bf = $("#btnClearFav");
    const bh = $("#btnClearHist");
    if(bf) bf.addEventListener("click", ()=>{ localStorage.removeItem(LS_FAV); alert("Favoritos limpos."); renderList(); });
    if(bh) bh.addEventListener("click", ()=>{ localStorage.removeItem(LS_HIST); alert("Hist√≥rico limpo."); renderList(); });
  }

  // ============ META / COUNTS ============
  function updateMeta(){
    if(!state.data){
      el.metaLine.textContent = "√öltima atualiza√ß√£o: ‚Äî ‚Ä¢ Fonte: ‚Äî";
      return;
    }
    const updatedAt = state.data.updatedAt || "‚Äî";
    const source = state.data.source || "‚Äî";
    const total = state.games.length;

    const dk = state.filter.dateKey || todayKeyBRT();
    const todayCount = state.gamesByDate.get(dk)?.length || 0;

    const now = Date.now();
    const max24 = now + 24*3600*1000;
    let next24 = 0;
    for(const g of state.upcomingSorted){
      const ts = g.kickoffTs || 0;
      if(ts < now) continue;
      if(ts > max24) break;
      next24++;
    }
    const live = state.liveGames.length;

    el.metaLine.innerHTML = `
      √öltima atualiza√ß√£o: <b>${updatedAt}</b> ‚Ä¢ Fonte: <b>${source}</b><br/>
      Jogos no arquivo: <b>${total}</b> ‚Ä¢ Hoje: <b>${todayCount}</b> ‚Ä¢ Pr√≥x 24h: <b>${next24}</b> ‚Ä¢ Ao vivo: <b>${live}</b>
    `;
  }

  // ============ UI STATE (pills/nav) ============
  function setActivePills(){
    // mode
    el.pills.liveUpcoming.classList.toggle("active", state.filter.mode==="live+upcoming");
    el.pills.live.classList.toggle("active", state.filter.mode==="live");
    el.pills.calendar.classList.toggle("active", state.filter.mode==="calendar");

    // country
    el.pills.brazil.classList.toggle("active", state.filter.country==="Brazil");
    el.pills.europe.classList.toggle("active", state.filter.country==="Europe");
    el.pills.all.classList.toggle("active", state.filter.country==="all");

    // window chips
    $$("#windowChips .chipBtn").forEach(b=>{
      b.classList.toggle("active", Number(b.dataset.hours)===state.filter.windowHours);
    });

    el.windowInfo.textContent = `Pr√≥ximas ${state.filter.windowHours}h ‚Ä¢ BRT`;
    el.proSub.textContent = `Janela ativa: ${state.filter.windowHours}h ‚Ä¢ Fuso: BRT`;

    // nav
    el.nav.games.classList.toggle("active", state.view==="games");
    el.nav.favs.classList.toggle("active", state.view==="favs");
    el.nav.hist.classList.toggle("active", state.view==="hist");
  }

  function setView(v){
    state.view = v;
    state.render.page = 1;
    setActivePills();
    renderList();
  }

  // ============ MENU SHEET ============
  function openSheet(){
    el.sheet.back.classList.add("open");
    el.sheet.sheet.classList.add("open");
  }
  function closeSheet(){
    el.sheet.back.classList.remove("open");
    el.sheet.sheet.classList.remove("open");
  }

  // ============ EVENTS ============
  function bind(){
    // Menu
    el.sheet.btn.addEventListener("click", openSheet);
    el.sheet.close.addEventListener("click", closeSheet);
    el.sheet.back.addEventListener("click", closeSheet);
    el.sheet.items.forEach(item=>{
      item.addEventListener("click", ()=>{
        const go = item.dataset.go;
        closeSheet();
        if(go==="favs") setView("favs");
        if(go==="hist") setView("hist");
        if(go==="config") setView("config");
      });
    });

    // Nav
    el.nav.games.addEventListener("click", ()=>setView("games"));
    el.nav.favs.addEventListener("click", ()=>setView("favs"));
    el.nav.hist.addEventListener("click", ()=>setView("hist"));

    // Pills modes
    el.pills.liveUpcoming.addEventListener("click", ()=>{
      state.filter.mode="live+upcoming";
      state.render.page=1;
      setActivePills();
      renderList();
    });
    el.pills.live.addEventListener("click", ()=>{
      state.filter.mode="live";
      state.render.page=1;
      setActivePills();
      renderList();
    });
    el.pills.calendar.addEventListener("click", ()=>{
      state.filter.mode="calendar";
      state.render.page=1;
      setActivePills();
      renderList();
    });

    // Country
    el.pills.brazil.addEventListener("click", ()=>{
      state.filter.country="Brazil";
      state.render.page=1;
      setActivePills();
      renderList();
    });
    el.pills.europe.addEventListener("click", ()=>{
      state.filter.country="Europe";
      state.render.page=1;
      setActivePills();
      renderList();
    });
    el.pills.all.addEventListener("click", ()=>{
      state.filter.country="all";
      state.render.page=1;
      setActivePills();
      renderList();
    });

    // Window chips
    el.windowChips.addEventListener("click", (e)=>{
      const btn = e.target.closest(".chipBtn");
      if(!btn) return;
      const h = Number(btn.dataset.hours);
      if(!Number.isFinite(h) || h<=0) return;
      state.filter.windowHours = h;
      state.render.page=1;
      setActivePills();
      renderList();
    });

    // Date apply
    el.btnApplyDate.addEventListener("click", ()=>{
      const v = el.datePicker.value;
      if(v){
        state.filter.dateKey = v;
        state.filter.mode = "calendar";
        state.render.page=1;
        setActivePills();
        renderList();
      }
    });

    // Search (debounce)
    let t=null;
    el.search.addEventListener("input", ()=>{
      clearTimeout(t);
      t=setTimeout(()=>{
        state.filter.q = normalizeText(el.search.value);
        state.render.page=1;
        renderList();
      }, 160);
    });

    // Clear
    el.btnClear.addEventListener("click", ()=>{
      el.search.value="";
      state.filter.q="";
      state.render.page=1;
      renderList();
    });

    // Refresh
    el.btnRefresh.addEventListener("click", async ()=>{
      await boot(true);
    });

    // Delega√ß√£o de a√ß√µes nos cards
    el.games.addEventListener("click", (e)=>{
      const b = e.target.closest("button[data-action]");
      if(!b) return;
      const action = b.dataset.action;

      if(action==="details"){
        const card = b.closest(".game-card");
        const det = card?.querySelector("details");
        if(det) det.open = !det.open;
        return;
      }

      const id = String(b.dataset.id || "");
      if(!id) return;

      if(action==="fav"){
        const favs = getSet(LS_FAV);
        if(favs.has(id)) favs.delete(id); else favs.add(id);
        saveSet(LS_FAV, favs);
        b.textContent = favs.has(id) ? "‚òÖ Favoritado" : "‚òÖ Favoritar";
        return;
      }

      if(action==="seen"){
        const hist = getSet(LS_HIST);
        if(hist.has(id)) hist.delete(id); else hist.add(id);
        saveSet(LS_HIST, hist);
        b.textContent = hist.has(id) ? "Visto ‚úì" : "Marcar visto";
        return;
      }
    });
  }

  // ============ BOOT ============
  async function boot(force=false){
    try{
      if(!force && state.data){
        setActivePills();
        updateMeta();
        renderList();
        return;
      }

      const json = await loadData();
      state.data = json;
      state.games = Array.isArray(json.games) ? json.games : [];
      buildIndexes(state.games);

      if(!state.filter.dateKey) state.filter.dateKey = todayKeyBRT();
      el.datePicker.value = state.filter.dateKey;

      setActivePills();
      updateMeta();
      renderList();
    }catch(err){
      console.error(err);
      renderEmpty(`<b>Erro ao carregar jogos</b><br/><span style="color:rgba(255,255,255,.75)">${err?.message || "Tente novamente."}</span>`);
    }
  }

  // start
  bind();
  boot(false);

})();
</script>
</body>
  </html>
